#! /bin/bash

# This script is used to sync a local directory with a remote one using unison.
# It notifies you when a conflict occurs and allows you to resolve it manually by running the script again with the -i option.

# Change the following variables to suit your needs:
REMOTE_HOST="cocinero-tarneo" # the remote host to sync with. This MUST be an SSH alias as defined in your ~/.ssh/config file.
REMOTE_DIR="sync"             # the remote directory
LOCAL_DIR="$HOME/.sync"       # the local directory, preferably an absolute path.

# Verify the remote host is defined in ~/.ssh/config
grep -q "^Host ${REMOTE_HOST}$" ~/.ssh/config || {
    echo "The remote host '${REMOTE_HOST}' is not defined in ~/.ssh/config."
    exit 1
}

# parse arguments
while getopts 'ih' opt; do
    case "$opt" in
      i)
          interactive=1
          ;;
      h)
          echo "Usage: $0 [-i] [-h]"
          echo "  -i: interactive mode: allows you to resolve conflicts manually, only syncs once"
          echo "  -h: this help"
          exit 0
          ;;
      *)
          echo "Usage: $0 [-i] [-h]"
          exit 1
          ;;
  esac
done


# Verify notify-send is installed.
which notify-send &> /dev/null || {
    echo "notify-send is not installed. This script needs it to work."
    exit 1
}

if [[ -n "$interactive" ]]; then
    # interactive mode: sync once with user input and exit
    echo -e "\e[33mReminder: when faced with a conflict, use '<' and '>' to select which way to force the sync,"\
        "or just press enter to skip the file and solve the conflict manually later.\e[0m"
    echo unison -auto -times "${LOCAL_DIR}" "ssh://${REMOTE_HOST}/${REMOTE_DIR}"
    exec unison -auto -times "${LOCAL_DIR}" "ssh://${REMOTE_HOST}/${REMOTE_DIR}"
fi

counter=0 # count how many times we've failed to sync

while true; do
    # check if unison ran into an error
    if ! unison -auto -batch -times "${LOCAL_DIR}" "ssh://${REMOTE_HOST}/${REMOTE_DIR}"; then
        counter=$((counter+1))
        echo "Unison failed for the ${counter}th time in a row."
        # if we've failed 10 times in a row, exit
        [[ $counter -ge 10 ]] && {
            notify-send -t 0 "Unison ran into a conflict or another error" "File sync is stopped, please use '$0 -i' to resolve conflicts manually."
            exit 1
        }
    else
        counter=0
    fi
    sleep 10
done
